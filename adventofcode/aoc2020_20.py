data = '''Tile 2053:
......#.#.
#....#....
#.#.......
.##.#..#.#
.##...####
#.#....#.#
##.##.#.#.
...##.....
####.##..#
#..##...##

Tile 1543:
.####.##..
.......#.#
..........
..#.......
#......#..
#....##...
#.#....#..
#..##....#
#.#..#....
#.#...####

Tile 2441:
.##.#..##.
#..#......
..#...#.##
...#.....#
#..##.....
......##..
###.#....#
##...#.#..
...#...###
.#..#.##.#

Tile 3733:
..#..#....
..#.#.....
......#.##
.#..#.##.#
..#....#..
......#..#
.###.#....
.#.#..#..#
.#....#...
#..#..##..

Tile 2237:
###.....#.
#..#.....#
........#.
#.#.......
#........#
##...#...#
..#.......
#.......##
##..#....#
...###...#

Tile 2203:
##..#....#
.....##...
...#....##
.........#
##....#..#
#.#..#.#..
.......###
.#....#..#
......###.
...#..#.##

Tile 1783:
#...##..#.
........#.
#..#.###.#
....#.##..
....#....#
..#.#....#
.........#
##.#.....#
#.#.....##
#....#..#.

Tile 1487:
#.....#...
#..#.#...#
..........
.........#
#.....##.#
....###.##
##...#...#
##......##
........#.
....#####.

Tile 3209:
...#....##
#...##..#.
..#.....##
#.##...###
...#..##.#
..#..#....
......#.#.
..........
.##...##.#
#..##.####

Tile 2557:
#......#.#
...#......
##.###.#..
.###....##
#.........
....#.#...
.#..###..#
...#...##.
.#.....#.#
.###.##.#.

Tile 1009:
###.##....
###.#..#.#
#.#....#..
.....##.##
...#.#....
..#.##.#..
#..##.#.##
#..#......
#..#...#.#
#..#.#..##

Tile 1361:
#..#..###.
....#...#.
##.#....##
......#..#
.........#
##..##...#
#...##...#
#...#.....
..##....##
#..#..####

Tile 2767:
.#.###.###
#.#.......
...#...##.
#..#...#..
#.#...#...
.#........
##....#...
#....#.#..
#.......#.
#.#.#..#..

Tile 1109:
.#..#..#.#
.....#..#.
......#..#
..##...#..
...#.#..##
...#.#..##
......##..
#...#..#..
#...#.....
..#.#.#.#.

Tile 1493:
###..####.
....##...#
#..#.#....
##.....#..
#..#.#..#.
#.........
#...#.#.#.
#.#..#.#.#
##.....#.#
#.#.#.###.

Tile 2971:
#####...#.
....#.....
#.......##
..#.#...##
...#.##..#
###.#..###
#......#.#
..........
...#..#...
.....#..##

Tile 2909:
.######.##
###..#...#
#....###..
#.####...#
..#.##....
#.........
..#.#....#
.#.##.##..
##.###.#.#
...##..#..

Tile 2551:
.#.##.#.#.
###.#..##.
#.......#.
##.......#
..###.....
#.##..#...
#.##....#.
#......#.#
......#.##
#.#...#..#

Tile 2917:
..###.##..
..#...#..#
#........#
#....##.##
#.........
...##.....
.###...##.
#.#...##..
.#.#.#.##.
.#.#..####

Tile 1553:
..##..#..#
#..#...#.#
#.#....#.#
##........
.###...#..
#.##.##.##
.....#..#.
#.....##..
.......#.#
##.#.#.##.

Tile 2297:
.##.##.#..
.##.#..##.
...#.#.###
...##...##
.#..##..##
##.#......
...#.....#
#.#.#...#.
.#......##
....#.##.#

Tile 1789:
####....#.
#.#.#..#..
...##.####
##.#.#...#
.###.....#
.#.#...##.
#...##.#..
##...#...#
..#.......
#######...

Tile 3079:
#.##..#.#.
#........#
..#..#....
..#..###.#
.......#.#
#....#####
#......##.
#..##.#...
#.......#.
###..##.##

Tile 3037:
..####.###
....##.#..
.......##.
....#...#.
..#.#.....
.#......##
##....##..
#..#.#.#..
##......##
###..###..

Tile 2677:
##.#..#...
.#........
..###..#.#
..##.....#
.##....#.#
#.#...#..#
......#.##
.......#.#
..........
#.#.#..###

Tile 1129:
.##.#.#.##
.........#
#.##.#....
.#...##..#
.#...#...#
..#..#.#..
##..#....#
##........
..#.##.###
##..#.####

Tile 2647:
.......#..
#........#
.....#.#..
.......##.
##..#.....
.#.###..#.
#....#.##.
#.#....#..
#.#..#...#
..##.###.#

Tile 2531:
#.#.##..##
##..#...#.
..#.......
##.......#
..........
.....#...#
#..###...#
#........#
#.........
.####..##.

Tile 1663:
.#.#..#...
..#...#...
##...##.#.
...#...#..
.##....#..
#........#
...#...#..
##....#..#
#.....#...
.####.##..

Tile 1193:
#......##.
..#.#.###.
#..#.....#
#.##.....#
.....#..##
....#.#..#
#..#.....#
..........
...###....
#..#.#.###

Tile 2477:
.#...#.##.
#....##..#
#.##.#...#
##..#.....
.........#
..#..#...#
.##...#.##
#.###.....
#..##.....
..#.##.#.#

Tile 2083:
.#.#.#.#..
###.#.....
.....#..##
...#.#....
#.......#.
.#.###....
#.#.#.....
.##..#.#.#
#.##.....#
..##.#.##.

Tile 2897:
###.####..
..##....##
###...#...
.......#..
#..#.#..#.
.....###..
......##..
....##..#.
.#...##..#
#.....#..#

Tile 3797:
#.....#...
..#.####.#
#....#.#..
#.....#.##
##..#.....
#....#..##
...#...#.#
.#....####
##.##.###.
###.#.#...

Tile 2087:
#####....#
..##...##.
...#......
.##......#
#..#....#.
.#..#....#
..##......
#........#
#.......#.
#.#.##...#

Tile 2447:
#.##....#.
##........
##........
#.#...#..#
##.#...#..
#..#..##.#
#........#
........#.
#...#....#
#.....#.##

Tile 1511:
#...#####.
..#.......
.........#
..#......#
###.......
.....#..##
#..#.....#
#.##.#....
......#..#
###.#.#.##

Tile 1249:
#.#..##...
#...#.#.#.
......#..#
#....##...
....#.##..
.#..##...#
#....###..
#....#....
.....#...#
...###.##.

Tile 2741:
###..#..#.
#.##.#...#
#...#....#
.....#...#
#.....#.#.
#.##.#...#
#.#..#...#
......#.#.
#...#..#..
..####.#..

Tile 3607:
#.#####..#
#..#.#.#.#
.......##.
#........#
#.#..#....
#..##.####
...#..#.#.
........##
..#...#.#.
...#..#..#

Tile 3877:
###..##...
##...#....
#.........
........##
#....#...#
#...#....#
.....#....
...#...#.#
#..#.#...#
.##...###.

Tile 1277:
..#....#.#
####..#...
#.........
..........
#...#..##.
...#.#...#
#........#
....#.....
...#..#..#
##.#....##

Tile 3491:
..#...##..
.........#
#.........
...#......
...#..#.##
#...##....
#....#.#..
#....##...
..#.#..#.#
#.#.#.#.#.

Tile 2011:
..##...##.
....#.#..#
#..#....##
..........
..........
.....#...#
#..#.#...#
........##
.#.......#
##.......#

Tile 1087:
#.#.#.#.#.
..#..#..##
#.###.....
#...#..#.#
#....#...#
#....#...#
..##..#.##
#...##....
##........
#......##.

Tile 3307:
#..##..#.#
...#######
#......###
..#......#
#....##..#
.#.#.#...#
#........#
#.......##
..#..#...#
#.#..##.#.

Tile 1949:
#.###..##.
#.#......#
#....#.##.
##......#.
#.......##
#.##.#...#
.##....#..
..........
...###....
..#..##..#

Tile 1061:
...#..#..#
#.....#..#
##.#....##
.#....#..#
..........
#.......##
.#.#.....#
..........
#.#...#.#.
........#.

Tile 1429:
##.#####..
.#........
#....#....
...#......
#........#
##.....#.#
....##.#..
....#..##.
#...#....#
###.#.##.#

Tile 2221:
###.#.....
#.......#.
....##.#.#
........##
..#..#....
..###....#
#........#
##.#.#....
#...#...##
##.######.

Tile 1117:
..#.##.#.#
##.......#
..#.#.....
.##......#
.##..#....
.........#
..#.......
##.#.#.#.#
#.#.......
#.#..#...#

Tile 1571:
..##.##..#
...#...#.#
#.##......
#..#......
..#..#...#
#.......##
...##....#
..#.#....#
#.#..#..##
.##..#.#..

Tile 2969:
.##..#..#.
..........
#......#..
#...#....#
..........
..##.#.###
.....#....
.......#.#
####..#.#.
..##..#...

Tile 2713:
####.##.#.
#.##.#.#..
#...##....
#......#..
#.##.#....
#.........
..##...#.#
#...#.#.#.
#.......##
..####..##

Tile 3121:
....#.##..
..#......#
..#..##...
#.#......#
#....#..##
....##...#
#..#.#....
#.....#..#
..#...#.#.
.#..####.#

Tile 3673:
.#.##..###
..#.#.....
...#..#..#
..........
.##....###
#..#...#..
#..##..#..
#...#.....
##.#..#..#
....##.###

Tile 2683:
..#...#.##
..#..##.##
###..#....
###..#..##
.......#..
..##.....#
#.....#..#
#.###.#.#.
#.#.#.###.
..#.#...#.

Tile 2617:
.#...#....
.......###
.##..#....
..#..###.#
#..##..#.#
#.#.###..#
..#..###.#
.#....#..#
##....#.##
..#.#..###

Tile 2341:
......###.
..#..#....
..#.#...#.
..#.#.###.
...##.#..#
##......#.
.........#
#..#...#..
#.......##
###...#...

Tile 1609:
..##.#.#..
#.......##
#......#.#
#.......#.
..##...#..
...#.#....
##......#.
.###...#..
.#....#..#
....#####.

Tile 3299:
#####.####
.##.....#.
..#...#...
...#....#.
#..#.#...#
#...#...##
#.....##.#
....#.##..
##....#...
.##..##.#.

Tile 1259:
##.#......
........#.
.....#.###
....#.#.##
#.....#.##
..#....#.#
..........
.##.##...#
....##..#.
...#...#..

Tile 2803:
.#..#.#..#
#...###..#
..###.####
#....#.#.#
##.......#
#.#.#.#...
.#.#.#.#.#
#....#....
....#....#
...###..#.

Tile 1063:
.#.##.##.#
......#.##
.#..#.##..
#....###..
....###...
.##....#.#
#.#.#....#
.....#..#.
##......##
.######..#

Tile 2113:
..#.######
####.....#
#.#....##.
........##
#.#.....##
...#.....#
#.........
#.....#..#
##.##.#.##
.##.###.##

Tile 1531:
.###..#.##
#.....##.#
.......#.#
........##
#.....#...
#.#.#...#.
..#...#..#
##.##.##..
..........
#...#...##

Tile 1289:
##.###.###
....#..#..
####....##
#.#....#..
#.........
#.#....#.#
...#......
.##.......
##..#.....
...##.####

Tile 3529:
###..#.#.#
#..###....
....#...##
.#....###.
##...#....
#.##.#.#..
####..#.#.
#....#....
#.##.##..#
#.##.#....

Tile 2389:
.##.##.#..
#.###...##
..##....##
#.###.#...
#.#......#
.#......##
##..#.#..#
#..#......
..###.....
#.#####..#

Tile 3727:
#.#.##..#.
##.###.###
#....##...
#....#...#
..##.....#
......#.#.
#.....#...
..........
#..#....##
.#.##.#...

Tile 1013:
##.#.#####
#.####...#
#..#....#.
#....##...
........##
.#.#.#....
#..#..##..
#.#.#.###.
...##..##.
##.###...#

Tile 3373:
.##..#.###
.....#....
...#..#...
#...#....#
#..####..#
#...#.##.#
.....##.##
....#.....
...##....#
.#..###...

Tile 3041:
.#..#.####
..........
.........#
..#.....#.
.....#....
#..#....#.
.......#.#
..#......#
....#..#..
..####..##

Tile 1627:
.###.#...#
...#..#.##
#...###..#
..#.......
##...##...
#.....####
##........
#..#......
#.##.....#
...#...#.#

Tile 1297:
#..#...#.#
#.........
..#.#..#..
..#......#
.#..##...#
....#..#.#
#...###...
#...#....#
#..#..#..#
##..#.#..#

Tile 1787:
####.....#
.....##..#
..........
#...#.....
..........
..#..#.#..
#..#..###.
#......##.
...##..#..
##.....###

Tile 3109:
##.###..##
.#.#......
.#.......#
#.........
#.#..#.#..
#.#....#..
#.....#..#
........##
##..#....#
##.###..#.

Tile 3541:
.##.####.#
.....#.#.#
#.........
.#.##...##
..........
#.......##
.#......##
.....###.#
##...##...
.#...#.##.

Tile 3347:
....##.#.#
..#..#..##
.#..#.##.#
....#.....
....#.....
#.....##.#
#....#....
##....#...
.#.......#
####.##.##

Tile 1721:
###.#.##.#
##..#.....
#.......#.
.#..##..#.
#.##....##
...#....##
##...#..#.
#.#.#.#...
#.#...#.##
..########

Tile 1847:
#...##.#.#
..#...#...
##........
.##......#
........##
.#.#.#....
.##.#....#
#..#......
.#..#..###
.#.##..###

Tile 3329:
###......#
##....#...
#.........
##.#.##.##
#.#.......
..........
##......#.
...#...###
#...#..##.
#......#..

Tile 3881:
.#.#..##..
##..#...#.
.......#..
#.#..#...#
#.#..#..##
#..##.##.#
#...#..#.#
#..#......
..#...#.#.
.####..###

Tile 1709:
#####.#.#.
.#.##..###
##..##...#
#####....#
#..#......
....#..#..
#...#.#...
#...#.#...
#..#.....#
#..#.####.

Tile 1171:
...#.#.#.#
#.....#...
#..#......
.......##.
.....#....
#...#...#.
#........#
#....#....
..#......#
...#.#.#..

Tile 1499:
########.#
#..#.###.#
...#.###..
#......#.#
###......#
...#......
#...##.#..
....#.#..#
###.#.#...
####.##..#

Tile 1283:
.##.###.#.
#.........
..#..##.##
....#.....
#.#.##..#.
.##...#..#
#........#
....#...##
.....##..#
#.#.###..#

Tile 1637:
.#.##.###.
....#.....
#..##.##..
.###...##.
####.....#
##.....#..
#.....##..
#.#.##.#..
#........#
#.#.###.#.

Tile 3911:
##.###....
#.#.##....
.#...#...#
.#.#.#...#
.#.....#..
##....##..
#.........
..#.#.....
##....#..#
##..###...

Tile 3259:
...#...#.#
...#..#..#
#.#.###...
#..#...#.#
#....###.#
....#.....
.#....#..#
#........#
#....#..##
##...#.##.

Tile 2099:
##.##..###
.....#.###
...##..#.#
..#.......
.###.#...#
..##.#.#..
#.#.......
#.##.....#
...#..###.
.##..#.#..

Tile 1237:
.##..###..
###..#....
#...#.#...
#......#..
.....#..#.
......##..
#...#.....
#.........
.#......##
...##.##..

Tile 1987:
#..#.#.###
...#...#..
#.#....#.#
..#...#...
....#..##.
#........#
.#.#.#..#.
#....###.#
#.#....#.#
..######.#

Tile 2539:
##.#...#..
..#..#.##.
#.....#...
#...#.#...
.........#
#.........
......#..#
#......#.#
......#.#.
.#..##....

Tile 2269:
#.##.#..##
#.......##
.#...#.##.
.##......#
.##.##....
#..#...#..
.#..#...#.
###.....#.
#......###
...#####.#

Tile 1583:
.##.####.#
...#....##
.........#
.....#...#
.#...##.##
#.....#..#
.#.#.#....
...#..#.#.
#..#.#...#
#.#..#.###

Tile 2749:
.#..#...#.
....##.###
##...#....
#.#..##.##
#.#..#....
.#.#..#..#
#...#..#..
####..#..#
#.#.#..#.#
#..##.##..

Tile 1613:
#.#.#.#..#
....#.##.#
....#.....
.#...###.#
.###.##..#
###.#.....
#.#....#.#
..#..#...#
#...#...#.
#.##.####.

Tile 1823:
...####..#
#....#...#
.....##.#.
....#.#..#
.#..##..##
#####.....
....##....
#....#...#
....#.....
...#.#.#.#

Tile 3821:
.#####.###
##....##..
##.#.##..#
.##...#..#
.##.....##
...#..#...
......#..#
.....#...#
.#.####.#.
..#.#....#

Tile 1451:
#..#..###.
###...#...
.......##.
.#......##
#.#.......
...#.....#
#.........
##....##..
#......###
##...###.#

Tile 1913:
#########.
#........#
#.##..#..#
.###.....#
##.......#
###.......
.....#...#
#...#.....
#.##......
..#.#..###

Tile 1307:
.#.##.#.#.
#..#..##.#
#.#...#..#
...#..#..#
#...#.....
#...#....#
.......##.
....#.....
...#.#....
##.###.#..

Tile 1777:
..#..##..#
##....#...
#...#..#..
.##...#..#
###.##.#.#
........##
.....#....
##.....#..
..#..#.#..
.##..##...

Tile 3011:
#.#..##.#.
#.....#..#
.###...#..
..........
#.....#...
...#.#....
#..#.....#
...#..##.#
#......#.#
...###....

Tile 2459:
#.##.##.##
.##.#....#
.....#.#.#
#.##...#..
.###.#.#..
.##.......
#.#..#....
.#.....#..
#.#...#.##
#.####.###

Tile 1123:
....#...##
..###.#.#.
....#.....
#.#..#..##
#.#..#..#.
.#..#.####
....#.###.
#..#.....#
........##
.####.....

Tile 3917:
##.#.#.###
.........#
........#.
.....#....
.#.....#.#
#.....#.#.
#..#...#..
#.........
#........#
#####..#.#

Tile 2287:
##.##.###.
##.....###
..#.....#.
#.....#.#.
#..#.#.###
.#...#...#
#..###..#.
#..##.....
###...#..#
#..####.##

Tile 1471:
#.##...#..
.##.#.#..#
#.......##
.......###
....#.#...
##.......#
#....#...#
#....###..
.##.#.##..
####.#....

Tile 2357:
####......
..#.......
#.#...#..#
#.........
..........
##..#..#..
.#..###...
..#..##...
##....###.
##...#....

Tile 1319:
###...###.
..#..#....
#..#.....#
......#.##
.........#
...#....#.
###..#...#
###..##..#
....##.#..
#...#.....

Tile 3467:
..#...#...
.#.....#.#
..#......#
..#......#
#..#....#.
.#....#.#.
##..#.....
###....#..
#.....##..
##...#...#

Tile 3407:
.###..####
#....#...#
#.........
..#....#.#
..#.....##
.#.....#.#
..#.#..#..
#..#.##...
.#....##..
.#####.###

Tile 2801:
#..##..##.
..#.....##
.....#....
..#...##..
#.#....#.#
#....#.#.#
..#...#.##
#.#..##..#
#...#.#..#
##.....#.#

Tile 1021:
......#.#.
...#...#..
#.#......#
##..#..#.#
##..#.....
..#..#..#.
......##.#
......##..
..##......
##....#...

Tile 3677:
#.#.......
#...#.##.#
....#..#.#
.#...#....
..........
.........#
..#..#.#.#
#.#.##...#
..##.....#
#.##.##.##

Tile 1321:
.#.#...#.#
#..##...##
#.#.....#.
###.......
#........#
.#..#....#
#.##.##...
#.#....##.
.##.....##
#.#####...

Tile 1607:
....###..#
..#...#...
.#.......#
#...#.....
...#......
#.........
#...#.....
........##
##...#...#
#....#.#.#

Tile 1979:
##.#.#....
.#..#...##
#.......#.
..........
..#...#...
.....#...#
.........#
...#..###.
.###......
#####..#..

Tile 2927:
#.##..###.
#.#......#
......#...
...#....##
#....##...
##.......#
#..#..#...
....#..#..
#...#.#..#
#.###.....

Tile 3203:
#.#..#..#.
.#.#......
....##..#.
....######
#........#
..#......#
##.#...#..
#......#.#
#.....#.##
.##..###.#

Tile 3323:
##..###.#.
.......#.#
.........#
#.........
........#.
.........#
###......#
..........
#...#.#..#
.##.#.###.

Tile 1489:
.#...##.#.
........##
.##.#...##
.......#.#
#.##.#.#.#
.##....##.
#....#..#.
#..#.....#
##.#.##.##
.#.#.#....

Tile 2273:
####.#..#.
##.#......
##..###.##
.##..#....
#..#.#...#
##...#....
#.#...#.#.
#..#.....#
##.#..#.#.
##...#..#.

Tile 2293:
.#.##.#...
..#.#.#.#.
.......###
#.#....#..
#......#.#
##..##.#.#
######..##
#.....#...
##....#..#
#.#####.##

Tile 1301:
#.....##..
#..#.....#
#......#.#
#....#....
##.#.#..##
......#...
#.........
#........#
#..#.....#
###..##...

Tile 1229:
.#..####..
##.....##.
##........
#...#.....
.#....#.#.
#.........
..#......#
##..##.#.#
#####....#
#..#.###..

Tile 3769:
.#..#.##.#
##.....#.#
#.#...#..#
..#..##..#
#.##.#####
.....##.#.
#.#.####..
.###...#..
#.#...#..#
.#.####...

Tile 3319:
######.###
....#...##
#..##..#.#
##.....#..
#.#.##..#.
#.#.#.....
.........#
#.#.#..###
....#..#.#
####....#.

Tile 3547:
##..#..##.
#.....#...
.#.......#
.......#.#
#.....#..#
#..##.#.#.
....#.#...
....#..#..
.....#....
...#.#..##

Tile 3643:
....####.#
...#......
.##......#
#...#.....
.......##.
##.......#
......##.#
#.....#...
#.#.......
######...#

Tile 1103:
#...#.#.#.
.........#
.....#....
.......#..
#......###
##......##
#..#.....#
#.#.....#.
#...#...##
.#.#...#.#

Tile 2711:
###.##.##.
....#...#.
##.......#
#.....#...
#...#.#.##
#..##.#...
..#....###
...#....##
.##.#####.
.##.##.#.#

Tile 1871:
#.###.####
.........#
#......#.#
..##....##
#..#..##.#
#..###...#
#.#.....##
......#.#.
.#.#.....#
#.#.#.....

Tile 3851:
..##.##.#.
.....#.#..
#....#...#
#..#..#..#
###.....#.
#.#..#..##
..#......#
.##.#....#
#....##.#.
.##..#.#.#

Tile 1151:
###......#
...##.....
....#.....
....#.....
#..#..#...
##....##..
..#......#
.#.....#.#
........##
.##.#..#.#

Tile 2377:
.##.##.#.#
.....##.##
###.......
#....##..#
##......#.
...#.##..#
#...#....#
.##..#.##.
#.###...#.
.#.#..##..

Tile 3581:
..#.#....#
..#.#..#..
.##..#.##.
#.##..##..
#.....#...
#..#...###
...#......
#.#.......
####......
#.#...####

Tile 1303:
##.#.#....
#.#.#.##.#
..#......#
.##.##...#
##..#..#..
#...#.#.##
##..#.#..#
..##.#....
#.........
.#.#..##.#

Tile 2843:
##.##..##.
#..##.##.#
#...#....#
#..#.####.
#...#.....
##....#..#
#...#.....
..#..###..
#..#..#..#
##..##...#

Tile 3617:
##...##..#
.#..#...#.
.##......#
#.####...#
##........
#.........
#......#..
##...#....
#.##..#..#
.##..##...

Tile 1091:
######..#.
....#.#..#
.....#...#
#....#...#
......#.##
...#.##...
#...#.....
..#.###...
#....#..##
#.###..#..

Tile 1213:
.##..#.#.#
.#..#..#..
##.#.#....
#....##..#
##........
##..#.....
#...#..#..
#...#..#..
#.......#.
#.....#.##'''

test = '''Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###...'''

#data = test

from collections import Counter, deque
from functools import reduce
from math import sqrt
import numpy as np

class Border:
    
    def __init__(self, string):
        self.string = string
        self.id = str(hash(self))[-4:-1]
    
    def __eq__(self, other):
        try:
            return self.string in (other.string, other.string[::-1])
        except AttributeError:
            return False
    
    def __hash__(self):
        return hash(tuple(sorted((self.string, self.string[::-1]))))
    
    def __repr__(self):
        return f'Border({self.string})'
    
    def __str__(self):
        return self.id

class Tile:
    
    def __init__(self, id, rows, borders):
        self.id = id
        self.array = np.array([list(row) for row in rows])
        self.borders = borders
    
    @property
    def up(self):
        return self.borders[0]

    @property
    def right(self):
        return self.borders[1]

    @property
    def down(self):
        return self.borders[2]
        
    @property
    def left(self):
        return self.borders[3]
    
    @property
    def border_ids(self):
        return [border.id for border in self.borders]

    def rotate(self, n=1):
        self.array = np.rot90(self.array, n)
        self.borders.rotate(-n)

    def flip(self):
        self.array = np.fliplr(self.array)
        self.borders = deque([self.up, self.left, self.down, self.right])

    def __repr__(self):
        return f'Tile({self.id}, {[border.id for border in self.borders]})'

    def __str__(self):
        return '\n'.join(''.join(row) for row in self.array)

def orientate_tile(id, left_border, up_border):
    #print(id, left_border, up_border)
    tile = tiles[id]
    #print(tile.border_ids)
    for flip in range(2):
        tile.flip()
        for rotation in range(4):
            tile.rotate()
            if ((up_border is None and tile.up in edge_borders) or tile.up == up_border) and ((left_border is None and tile.left in edge_borders) or tile.left == left_border):
                return

tiles = {}
border_counts = Counter()
for tile_data in data.split('\n\n'):
    id = int(tile_data.splitlines()[0].split()[1][:-1])
    rows = tile_data.splitlines()[1:]
    string = ''.join(rows)
    borders = deque(Border(border) for border in (rows[0], string[9::10], rows[-1], string[::10]))
    tiles[id] = Tile(id, rows, borders)
    border_counts.update(borders)
#print(tiles.keys())
#print(border_counts)
size = len(tiles)
length = int(sqrt(size))

edge_borders = {border for border in border_counts if border_counts[border] == 1}
for border in edge_borders:
    border.id = None
corner_ids = set()
edge_ids = set()
middle_ids = set()
for id, tile in tiles.items():
    edges = sum(border in edge_borders for border in tile.borders)
    if edges == 2:
        corner_ids.add(id)
    elif edges == 1:
        edge_ids.add(id)
    else:
        middle_ids.add(id)
print(reduce(lambda x, y: x * y, corner_ids))
#print(corner_ids)
#print(edge_ids)
#print(middle_ids)

grid = np.zeros((length, length))
it = np.nditer(grid, flags=['multi_index'], op_flags=['readwrite'])
while not it.finished:
    coords = it.multi_index
    #print(coords)
    if coords == (0, 0):
        id = corner_ids.pop()
        grid[coords] = id
        #print(tiles[id], tiles[id].border_ids)
        orientate_tile(id, None, None)
        #print(tiles[id], tiles[id].border_ids, '\n')
        it.iternext()
        continue
    edges = sum(index in (0, length-1) for index in coords)
    if edges == 2:
        pool = corner_ids
    elif edges == 1:
        pool = edge_ids
    else:
        pool = middle_ids
    left_id = grid[coords[0], coords[1]-1]
    up_id = grid[coords[0]-1, coords[1]]
    #print(left_id, up_id)
    try:
        left_border = tiles[left_id].right
    except KeyError:
        left_border = None
    try:
        up_border = tiles[up_id].down
    except KeyError:
        up_border = None
    #print(left_border, up_border)
    for id in pool:
        #print(tiles[id].border_ids)
        if left_border in tiles[id].borders or up_border in tiles[id].borders:
            #print(tiles[id], tiles[id].border_ids)
            orientate_tile(id, left_border, up_border)
            #print(tiles[id], tiles[id].border_ids, '\n')
            grid[coords] = id
            pool.remove(id)
            break
    it.iternext()
    #print(grid)

whole_length = length * 8
image = np.empty((whole_length, whole_length), dtype=str)
stride = image.strides[-1]
row_stride = stride * whole_length
#print(stride, row_stride)
windows = np.lib.stride_tricks.as_strided(image, (length, length, 8, 8), strides=(row_stride * 8, stride * 8, row_stride, stride))
for row, axis in zip(grid, windows):
    for id, window in zip(row, axis):
        tile = tiles[id]
        tile.array = tile.array[1:-1, 1:-1]
        window[...] = tile.array
#print(image)
#print('\n'.join(''.join(row) for row in image))
image = image == '#'
#print(image)
#print()

MONSTER = '''                  # 
#    ##    ##    ###
 #  #  #  #  #  #   '''
#monster = np.array([list(row) for row in MONSTER.splitlines()])
monster = np.array([[space == '#' for space in row] for row in MONSTER.splitlines()])
#print(monster)
monster_shape = monster.shape
#print(monster_shape)
monster_indices = monster.nonzero()
#print(monster_indices)
monster_pieces = np.count_nonzero(monster)
#print(monster_pieces)
#print()

monster_count = 0
for flip in range(2):
    image = np.flipud(image)
    for rotation in range(4):
        image = np.rot90(image).copy()
        #print('\n'.join(''.join('.#'[space] for space in row) for row in image))
        stride = image.strides[-1]
        row_stride = stride * whole_length
        #print(stride, row_stride)
        windows = np.lib.stride_tricks.as_strided(image, (whole_length - monster_shape[0] + 1, whole_length - monster_shape[1] + 1, *monster_shape), strides=(row_stride, stride, row_stride, stride))
        for window in (window for row in windows for window in row):
            #print(window)
            #print(window[monster_indices])
            monsters = np.all(window[monster_indices])
            #print(f'\n{monsters}\n')
            monster_count += monsters
        #print()
print(monster_count)
print(np.count_nonzero(image) - monster_count * monster_pieces)
